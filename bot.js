import TelegramBot from 'node-telegram-bot-api';
import cron from 'node-cron';
import fs from 'fs';
import path from 'path';
import 'dotenv/config'; // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¸Ğ· .env

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
const token = process.env.TELEGRAM_BOT_TOKEN;
const chatId = process.env.TELEGRAM_CHAT_ID;

if (!token) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: TELEGRAM_BOT_TOKEN Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½');
    process.exit(1);
}
if (!chatId) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: TELEGRAM_CHAT_ID Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½');
    console.log('â„¹ï¸ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ±Ğ¾Ñ‚Ñƒ Ğ² Telegram, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ chatId');
    process.exit(1);
}

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ° Ğ±ĞµĞ· polling
const bot = new TelegramBot(token, { polling: false });

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ principles.json
let principles;
function loadPrinciples() {
    try {
        const data = fs.readFileSync(path.resolve('principles.json'), 'utf-8');
        principles = JSON.parse(data).principles || ['ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…'];
        console.log('ğŸŸ¢ principles.json Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½:', principles);
    } catch (err) {
        console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ principles.json:', err.message);
        principles = ['ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹'];
    }
}
loadPrinciples();

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° 10 ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ğ¾Ğ²
function getRandomPrinciples(arr, count) {
    const shuffled = arr.slice().sort(() => Math.random() - 0.5);
    return shuffled.slice(0, Math.min(count, arr.length));
}

// ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° 10 Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ğ¾Ğ² ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² 9 ÑƒÑ‚Ñ€Ğ°
cron.schedule('*/3 * * * *', () => {

    loadPrinciples(); // ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ principles.json Ğ¿ĞµÑ€ĞµĞ´ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¾Ğ¹
    const selectedPrinciples = getRandomPrinciples(principles, 10);
    const text = 'âœ… Ğ’Ğ°ÑˆĞ¸ 10 Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ğ¾Ğ² Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ:\n\n' +
        selectedPrinciples.map((p, i) => `${i + 1}. ${p}`).join('\n');
    bot.sendMessage(chatId, text)
        .then(() => console.log('âœ… ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ 10 Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ğ¾Ğ² Ğ² 9:00'))
        .catch(err => console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸:', err.message));
});

console.log('ğŸŸ¢ Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½');